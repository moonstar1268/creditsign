<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CreditSign</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ CDN -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    #pdf-preview canvas {border:1px solid #ccc; margin-bottom:10px;}
    .hidden {display:none;}
    .text-box {
      position:absolute;
      font-size:16px;
      padding:4px;
      border:1px solid #333;
      background:#fff;
      cursor:move;
    }
  </style>
</head>

<body>
  <h1>CreditSign</h1>

  <!-- ì–‘ì‹ íƒ­ ë²„íŠ¼ -->
  <button id="form1-tab">ì–‘ì‹ 1</button>
  <button id="form2-tab">ì–‘ì‹ 2</button>
  <br><br>

  <button id="text-add">ğŸ“ í…ìŠ¤íŠ¸ ì¶”ê°€</button>
  <button id="open-pad">â• ì„œëª… ì¶”ê°€</button>
  <button id="download">â¬‡ï¸ ì„œëª…ëœ ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ</button>

  <div id="pdf-preview" style="position:relative;"></div>

  <!-- ì„œëª… ì…ë ¥ ëª¨ë‹¬ -->
  <div id="pad-wrapper" class="hidden">
    <canvas id="sig-canvas"></canvas><br />
    <button id="clear">Clear</button>
    <button id="save-sig">Save Signature</button>
  </div>

  <!-- ì €ì‘ê¶Œ ë¬¸êµ¬ -->
  <footer style="margin-top:20px; font-size:14px; color:#666;">
    Copyright (C) í•œêµ­ê¸ˆìœµë²”ì£„ì˜ˆë°©ì—°êµ¬ì„¼í„°. All rights reserved.
  </footer>

<script>
const pdfUrls = {
  "ì–‘ì‹ 1": "https://cors-anywhere.herokuapp.com/https://github.com/moonstar1268/creditsign/raw/0e1d51a9055b9b0c7c064f97295a7bccd0a16ca3/%ED%81%AC%EB%A0%88%EB%94%A7%EC%82%AC%EC%9D%B8%20%EA%B8%B0%EB%B3%B8%EC%84%B8%ED%8C%85%201.pdf",
  "ì–‘ì‹ 2": "https://cors-anywhere.herokuapp.com/https://github.com/moonstar1268/creditsign/raw/92b2d1f8901301b66d242b6efe5f0cae20cd75db/%ED%81%AC%EB%A0%88%EB%94%A7%EC%82%AC%EC%9D%B8%20%EA%B8%B0%EB%B3%B8%EC%84%B8%ED%8C%85%202.pdf"
};

let pdfDoc=null, pdfBytes=null, textMode=false;
const textEntries=[];

async function loadDefaultPDF(name){
  const pdfResponse=await fetch(pdfUrls[name]);
  pdfBytes=await pdfResponse.arrayBuffer();
  pdfDoc=await PDFLib.PDFDocument.load(pdfBytes);
  await renderPreview();
}

async function renderPreview(){
  const wrap=document.getElementById("pdf-preview");
  wrap.innerHTML='';
  const pdf=await pdfjsLib.getDocument({data:pdfBytes}).promise;

  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const viewport=page.getViewport({scale:1.0});
    const canvas=document.createElement("canvas");
    canvas.width=viewport.width; canvas.height=viewport.height;
    canvas.style.position='relative';
    await page.render({canvasContext:canvas.getContext("2d"),viewport}).promise;
    canvas.dataset.page=i-1;
    canvas.onclick=(e)=>canvasClickHandler(e,canvas);
    wrap.appendChild(canvas);
  }
}

function canvasClickHandler(e,canvas){
  if(textMode){
    const input=document.createElement("div");
    input.contentEditable=true;
    input.className="text-box";
    input.style.left=e.pageX+"px";
    input.style.top=e.pageY+"px";
    document.body.appendChild(input);
    input.focus();
    input.onblur=()=>{
      textEntries.push({
        text:input.innerText, 
        x:parseInt(input.style.left), 
        y:parseInt(input.style.top), 
        page:parseInt(canvas.dataset.page)
      });
    };
    dragElement(input);
    textMode=false;
  }
}

document.getElementById("text-add").onclick=()=>{
  textMode=true;
  document.getElementById("pad-wrapper").classList.add("hidden");
  alert("PDFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ê°€í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ê³  ì…ë ¥í•˜ì„¸ìš”.");
};

// âš ï¸ ëª…í™•íˆ ìˆ˜ì •ëœ ë¶€ë¶„ (ì„œëª… ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬)
document.getElementById("open-pad").onclick=()=>{
  textMode=false;  // <-- í…ìŠ¤íŠ¸ ëª¨ë“œ ì¢…ë£Œ (ì¤‘ìš”!)
  document.getElementById("pad-wrapper").classList.remove("hidden");
  initSignaturePad(); // ì„œëª…íŒ¨ë“œ ì´ˆê¸°í™” ë° ë³´ì´ê¸°
};

function initSignaturePad(){
  const canvas=document.getElementById("sig-canvas");
  if(window.signaturePad){window.signaturePad.clear(); return;}
  window.signaturePad=new SignaturePad(canvas);
  document.getElementById("clear").onclick=()=>signaturePad.clear();
  document.getElementById("save-sig").onclick=()=>{
    if(signaturePad.isEmpty()){alert("ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”");return;}
    document.getElementById("pad-wrapper").classList.add("hidden");
    alert("ì„œëª…ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ë‹¤ìš´ë¡œë“œ ì‹œ ë°˜ì˜ ì˜ˆì •)");
  };
}

function dragElement(el){
  let shiftX,shiftY;
  el.onmousedown=(e)=>{
    shiftX=e.clientX-el.getBoundingClientRect().left;
    shiftY=e.clientY-el.getBoundingClientRect().top;
    function moveAt(pageX,pageY){
      el.style.left=pageX-shiftX+'px';
      el.style.top=pageY-shiftY+'px';
    }
    function mouseMove(e){moveAt(e.pageX,e.pageY);}
    document.addEventListener('mousemove',mouseMove);
    el.onmouseup=()=>{
      document.removeEventListener('mousemove',mouseMove);
      el.onmouseup=null;
    };
  };
}

window.onload=()=>{
  pdfjsLib.GlobalWorkerOptions.workerSrc=
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  loadDefaultPDF("ì–‘ì‹ 1");
};

document.getElementById("form1-tab").onclick=()=>loadDefaultPDF("ì–‘ì‹ 1");
document.getElementById("form2-tab").onclick=()=>loadDefaultPDF("ì–‘ì‹ 2");

</script>
</body>
</html>
