<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CreditSign</title>
  <link rel="stylesheet" href="styles.css">

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    #pdf-preview canvas { border:1px solid #ccc; margin-bottom:10px; }
    .hidden { display:none; }
    #name-img, #signature-img {
      position:absolute; cursor:move; border:1px solid #333;
    }
  </style>
</head>
<body>
  <h1>CreditSign</h1>

  <button id="form1-tab">양식 1</button>
  <button id="form2-tab">양식 2</button>
  <br><br>

  <button id="name-add">이름 입력</button>
  <button id="open-pad">➕ 서명 추가</button>
  <button id="download">⬇️ 서명된 문서 다운로드</button>

  <div id="pdf-preview"></div>

  <div id="pad-wrapper" class="hidden">
    <canvas id="sig-canvas" width="400" height="200"></canvas><br/>
    <button id="clear">Clear</button>
    <button id="save-sig">Save</button>
  </div>

  <footer style="margin-top:20px;font-size:14px;color:#666;">
    Copyright (C) 한국금융범죄예방연구센터. All rights reserved.
  </footer>

<script>
const pdfUrls = {
  "양식 1": "크레딧사인 기본세팅 1.pdf",
  "양식 2": "크레딧사인 기본세팅 2.pdf"
};

let pdfBytes = null;
let padType = "";    // "name" or "sig"
let nameMode = false, sigMode = false;
let nameInfo = {}, sigInfo = {};

// PDF 불러오기 & 미리보기 렌더링
async function loadDefaultPDF(name) {
  const res = await fetch(pdfUrls[name]);
  pdfBytes = await res.arrayBuffer();
  nameMode = sigMode = false;
  nameInfo = {}; sigInfo = {};
  clearElements();
  await renderPreview();
}

function clearElements() {
  document.querySelectorAll('#name-img,#signature-img').forEach(el=>el.remove());
  document.getElementById("pad-wrapper").classList.add("hidden");
}

async function renderPreview() {
  const wrap = document.getElementById("pdf-preview");
  wrap.innerHTML = "";
  const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const vp = page.getViewport({ scale: 1.0 });
    const canvas = document.createElement("canvas");
    canvas.width = vp.width; canvas.height = vp.height;
    canvas.dataset.page = i - 1;
    canvas.onclick = e => onCanvasClick(e, canvas);
    await page.render({ canvasContext: canvas.getContext("2d"), viewport: vp }).promise;
    wrap.appendChild(canvas);
  }
}

// 캔버스 클릭 → 이름/서명 배치
function onCanvasClick(e, canvas) {
  const pageIndex = parseInt(canvas.dataset.page);
  const rect = canvas.getBoundingClientRect();
  const docCanvasLeft = rect.left + window.scrollX;
  const docCanvasTop  = rect.top  + window.scrollY;

  if (nameMode) {
    createPlacedImg("name-img", nameInfo, e.pageX, e.pageY, pageIndex);
    nameMode = false;
  } else if (sigMode) {
    createPlacedImg("signature-img", sigInfo, e.pageX, e.pageY, pageIndex);
    sigMode = false;
  }

  function createPlacedImg(id, info, px, py, page) {
    const img = document.createElement("img");
    img.id = id;
    img.src = info.dataURL;
    img.style.left = px + "px";
    img.style.top  = py + "px";
    img.style.width = "150px";
    document.body.appendChild(img);
    dragElement(img);
    info.page = page;
    // 문서 기준 위치 저장
    info.x = px;
    info.y = py;
  }
}

// 이름/서명 입력 버튼
document.getElementById("name-add").onclick = () => {
  padType = "name"; nameMode = sigMode = false;
  openPad();
};
document.getElementById("open-pad").onclick = () => {
  padType = "sig"; nameMode = sigMode = false;
  openPad();
};

function openPad() {
  document.getElementById("pad-wrapper").classList.remove("hidden");
  initSignaturePad();
}

// SignaturePad 세팅
function initSignaturePad() {
  const c = document.getElementById("sig-canvas");
  if (!window.signaturePad) {
    window.signaturePad = new SignaturePad(c);
    document.getElementById("clear").onclick = () => signaturePad.clear();
    document.getElementById("save-sig").onclick = () => {
      if (signaturePad.isEmpty()) {
        alert(padType==="name"?"이름을 입력하세요":"서명을 입력하세요");
        return;
      }
      const du = signaturePad.toDataURL();
      if (padType==="name") {
        nameInfo.dataURL = du; nameMode = true;
        alert("이름을 배치할 위치를 클릭하세요");
      } else {
        sigInfo.dataURL = du; sigMode = true;
        alert("서명을 배치할 위치를 클릭하세요");
      }
      document.getElementById("pad-wrapper").classList.add("hidden");
    };
  } else {
    signaturePad.clear();
  }
}

// 드래그 지원
function dragElement(el) {
  el.onmousedown = ev => {
    let shiftX = ev.clientX - el.getBoundingClientRect().left;
    let shiftY = ev.clientY - el.getBoundingClientRect().top;
    document.onmousemove = ev2 => {
      el.style.left = ev2.pageX - shiftX + "px";
      el.style.top  = ev2.pageY - shiftY + "px";
    };
    document.onmouseup = () => { document.onmousemove = document.onmouseup = null; };
  };
}

// PDF 다운로드
document.getElementById("download").onclick = async () => {
  const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
  const pages = pdfDoc.getPages();
  const canvases = document.querySelectorAll('#pdf-preview canvas');

  // 공통 함수: 배치된 이미지 PDF에 삽입
  async function embedImage(info) {
    if (!info.dataURL) return;
    const page = pages[info.page];
    const rect = canvases[info.page].getBoundingClientRect();
    const canvasLeft = rect.left + window.scrollX;
    const canvasTop  = rect.top  + window.scrollY;
    // 캔버스 내부 좌표
    const xCanvas = info.x - canvasLeft;
    const yCanvas = info.y - canvasTop;
    // PDF 비율
    const scaleX = page.getWidth() / rect.width;
    const scaleY = page.getHeight() / rect.height;
    // PDF 좌표 (원점이 왼쪽 아래)
    const x = xCanvas * scaleX;
    const y = page.getHeight() - (yCanvas * scaleY) - (50 * scaleY);
    const png = await pdfDoc.embedPng(info.dataURL);
    page.drawImage(png, { x, y, width: 150 * scaleX, height: 50 * scaleY });
  }

  await embedImage(nameInfo);
  await embedImage(sigInfo);

  // 저장
  const out = await pdfDoc.save();
  const blob = new Blob([out], { type: 'application/pdf' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href     = url;
  a.download = "signed.pdf";
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    URL.revokeObjectURL(url);
    a.remove();
  }, 3000);
};

// 초기 로드
window.onload = () => {
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  loadDefaultPDF("양식 1");
};
document.getElementById("form1-tab").onclick = () => loadDefaultPDF("양식 1");
document.getElementById("form2-tab").onclick = () => loadDefaultPDF("양식 2");
</script>
</body>
</html>
