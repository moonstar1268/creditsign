<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CreditSign</title>
  <link rel="stylesheet" href="styles.css">

  <!-- PDFâ€‘lib & ë¶€ê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@pdf-lib/fontkit@1.5.4/dist/fontkit.umd.min.js"></script> <!-- â˜… ì¶”ê°€ -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    #pdf-preview canvas {border:1px solid #ccc; margin-bottom:10px;}
    .hidden {display:none;}
    .text-box {
      position:absolute;font-size:16px;padding:4px;border:1px solid #333;background:#fff;cursor:move;
    }
    #signature-img {
      position:absolute;cursor:move;border:1px solid #333;
    }
  </style>
</head>

<body>
  <h1>CreditSign</h1>

  <button id="form1-tab">ì–‘ì‹ 1</button>
  <button id="form2-tab">ì–‘ì‹ 2</button>
  <br><br>

  <button id="text-add">ğŸ“ í…ìŠ¤íŠ¸ ì¶”ê°€</button>
  <button id="open-pad">â• ì„œëª… ì¶”ê°€</button>
  <button id="download">â¬‡ï¸ ì„œëª…ëœ ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ</button>

  <div id="pdf-preview"></div>

  <div id="pad-wrapper" class="hidden">
    <canvas id="sig-canvas" width="400" height="200"></canvas><br />
    <button id="clear">Clear</button>
    <button id="save-sig">Save Signature</button>
  </div>

  <footer style="margin-top:20px;font-size:14px;color:#666;">
    Copyright (C) í•œêµ­ê¸ˆìœµë²”ì£„ì˜ˆë°©ì—°êµ¬ì„¼í„°. All rights reserved.
  </footer>

<script>
/* ---------------- ê¸°ë³¸ ì„¤ì • ---------------- */
const pdfUrls = {
  "ì–‘ì‹ 1": "í¬ë ˆë”§ì‚¬ì¸ ê¸°ë³¸ì„¸íŒ… 1.pdf",
  "ì–‘ì‹ 2": "í¬ë ˆë”§ì‚¬ì¸ ê¸°ë³¸ì„¸íŒ… 2.pdf"
};
const KOREAN_FONT_URL =
  "https://cdn.jsdelivr.net/npm/@notofonts/korean-otf@0.1.1/NotoSansKR-Regular.otf"; // â˜… í•œê¸€ í°íŠ¸

let pdfBytes = null;
let textEntries = [], sigInfo = {};
let textMode = false, sigMode = false;

/* ---------------- PDF ë¶ˆëŸ¬ì˜¤ê¸° ---------------- */
async function loadDefaultPDF(name) {
  const res = await fetch(pdfUrls[name]);
  pdfBytes = await res.arrayBuffer();
  textEntries = []; sigInfo = {}; textMode = sigMode = false;
  clearPreviousElements();
  await renderPreview();
}

function clearPreviousElements() {
  document.querySelectorAll('.text-box,#signature-img').forEach(el => el.remove());
  document.getElementById("pad-wrapper").classList.add("hidden");
}

/* ---------------- ë¯¸ë¦¬ ë³´ê¸° ---------------- */
async function renderPreview() {
  const wrap = document.getElementById("pdf-preview");
  wrap.innerHTML = '';
  const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: 1.0 });
    const canvas = document.createElement("canvas");
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    canvas.dataset.page = i - 1;
    canvas.onclick = e => canvasClickHandler(e, canvas);
    await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;
    wrap.appendChild(canvas);
  }
}

/* ---------------- ìº”ë²„ìŠ¤ í´ë¦­ (í…ìŠ¤íŠ¸Â·ì„œëª… ìœ„ì¹˜ ì§€ì •) ---------------- */
function canvasClickHandler(e, canvas) {
  if (textMode) {
    const input = document.createElement("div");
    input.contentEditable = true;
    input.className = "text-box";
    input.style.left = e.pageX + "px";
    input.style.top = e.pageY + "px";
    document.body.appendChild(input);
    input.focus();
    input.onblur = () => textEntries.push({
      text: input.innerText,
      x: parseInt(input.style.left),
      y: parseInt(input.style.top),
      page: parseInt(canvas.dataset.page)
    });
    dragElement(input);
    textMode = false;
  } else if (sigMode) {
    const img = document.createElement("img");
    img.id = "signature-img";
    img.src = sigInfo.dataURL;
    img.style.left = e.pageX + "px";
    img.style.top = e.pageY + "px";
    img.style.width = "150px";
    document.body.appendChild(img);
    sigInfo.x = parseInt(img.style.left);
    sigInfo.y = parseInt(img.style.top);
    sigInfo.page = parseInt(canvas.dataset.page);
    dragElement(img);
    sigMode = false;
  }
}

/* ---------------- ë²„íŠ¼ ì´ë²¤íŠ¸ ---------------- */
document.getElementById("text-add").onclick = () => {
  textMode = true; sigMode = false;
  document.getElementById("pad-wrapper").classList.add("hidden");
  alert("í…ìŠ¤íŠ¸ ì¶”ê°€í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.");
};

document.getElementById("open-pad").onclick = () => {
  textMode = sigMode = false;
  document.getElementById("pad-wrapper").classList.remove("hidden");
  initSignaturePad();
};

/* ---------------- Signature Pad ---------------- */
function initSignaturePad() {
  const canvas = document.getElementById("sig-canvas");
  if (window.signaturePad) { signaturePad.clear(); return; }
  window.signaturePad = new SignaturePad(canvas);
  document.getElementById("clear").onclick = () => signaturePad.clear();
  document.getElementById("save-sig").onclick = () => {
    if (signaturePad.isEmpty()) { alert("ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”"); return; }
    sigInfo.dataURL = signaturePad.toDataURL();
    document.getElementById("pad-wrapper").classList.add("hidden");
    sigMode = true;
    alert("ì„œëª… ì¶”ê°€í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.");
  };
}

/* ---------------- ë“œë˜ê·¸ ì§€ì› ---------------- */
function dragElement(el) {
  el.onmousedown = e => {
    let shiftX = e.clientX - el.getBoundingClientRect().left,
        shiftY = e.clientY - el.getBoundingClientRect().top;
    document.onmousemove = e => {
      el.style.left = e.pageX - shiftX + 'px';
      el.style.top = e.pageY - shiftY + 'px';
    };
    document.onmouseup = () => { document.onmousemove = document.onmouseup = null; };
  };
}

/* ---------------- PDF ë‹¤ìš´ë¡œë“œ ---------------- */
document.getElementById("download").onclick = async () => {
  const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);

  /* â‘  fontkit ë“±ë¡ & í•œê¸€ í°íŠ¸ ì„ë² ë“œ */
  pdfDoc.registerFontkit(fontkit);
  const fontBytes = await fetch(KOREAN_FONT_URL).then(r => r.arrayBuffer());
  const koreanFont = await pdfDoc.embedFont(fontBytes, { subset: true });

  /* â‘¡ í…ìŠ¤íŠ¸ ì‚½ì… */
  const canvases = document.querySelectorAll('#pdf-preview canvas');
  textEntries.forEach(t => {
    const canvas = canvases[t.page];
    const rect = canvas.getBoundingClientRect();
    const page = pdfDoc.getPages()[t.page];
    const scaleX = page.getWidth() / rect.width;
    const scaleY = page.getHeight() / rect.height;

    const textX = (t.x - rect.left + window.scrollX) * scaleX;
    const textY = page.getHeight() - ((t.y - rect.top + window.scrollY) * scaleY);

    page.drawText(t.text, {
      x: textX,
      y: textY,
      size: 14,
      font: koreanFont            // â˜… í°íŠ¸ ì§€ì •
    });
  });

  /* â‘¢ ì„œëª… ì´ë¯¸ì§€ ì‚½ì… */
  if (sigInfo.dataURL) {
    const canvas = canvases[sigInfo.page];
    const rect = canvas.getBoundingClientRect();
    const page = pdfDoc.getPages()[sigInfo.page];
    const scaleX = page.getWidth() / rect.width;
    const scaleY = page.getHeight() / rect.height;

    const sigX = (sigInfo.x - rect.left + window.scrollX) * scaleX;
    const sigY = page.getHeight() - ((sigInfo.y - rect.top + window.scrollY) * scaleY) - 50;

    const png = await pdfDoc.embedPng(sigInfo.dataURL);
    page.drawImage(png, {
      x: sigX,
      y: sigY,
      width: 150 * scaleX,
      height: 50 * scaleY
    });
  }

  /* â‘£ Blob ìƒì„± & ë‹¤ìš´ë¡œë“œ (revoke ì§€ì—°) */
  const finalPdfBytes = await pdfDoc.save();
  const blob = new Blob([finalPdfBytes], { type: "application/pdf" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "signed.pdf";
  document.body.appendChild(a);   // iOSÂ·ì‚¬íŒŒë¦¬ ë“± í˜¸í™˜ì„±â†‘
  a.click();

  /* revokeObjectURL ì„ ì§€ì—° í˜¸ì¶œ */
  setTimeout(() => {
    URL.revokeObjectURL(url);
    a.remove();
  }, 5000);                       // 5ì´ˆ í›„ ì •ë¦¬
};

/* ---------------- ì´ˆê¸°í™” ---------------- */
window.onload = () => {
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  loadDefaultPDF("ì–‘ì‹ 1");
};
document.getElementById("form1-tab").onclick = () => loadDefaultPDF("ì–‘ì‹ 1");
document.getElementById("form2-tab").onclick = () => loadDefaultPDF("ì–‘ì‹ 2");
</script>
</body>
</html>
