<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CreditSign</title>
  <link rel="stylesheet" href="styles.css" />
  
  <!-- 라이브러리 CDN -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>        
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  
  <style>
    #pdf-preview canvas {border:1px solid #ccc; margin-bottom:10px;}
    .hidden {display:none;}
    #text-input {
      position:absolute; font-size:16px; padding:4px; cursor:move;
      border:1px solid #333; background-color:#fff;
    }
  </style>
</head>

<body>
  <h1>CreditSign</h1>

  <!-- 양식 탭 버튼 추가 -->
  <button id="form1-tab">양식 1</button>
  <button id="form2-tab">양식 2</button>
  <br><br>

  <button id="text-add">📝 텍스트 추가</button>
  <button id="open-pad" disabled>➕ 서명 추가</button>
  <button id="download" disabled>⬇️ 서명된 문서 다운로드</button>

  <div id="pdf-preview"></div>

  <!-- 텍스트 입력상자 (숨겨짐) -->
  <input type="text" id="text-input" class="hidden">

  <!-- 서명 입력창(모달) -->
  <div id="pad-wrapper" class="hidden">
    <canvas id="sig-canvas"></canvas><br />
    <button id="clear">Clear</button>
    <button id="save-sig">Save Signature</button>
  </div>

  <!-- 저작권 문구 -->
  <footer style="margin-top:20px; font-size:14px; color:#666;">
    Copyright (C) 한국금융범죄예방연구센터. All rights reserved.
  </footer>

<script>
  const pdfUrls = {
    "양식 1": "https://cors-anywhere.herokuapp.com/https://github.com/moonstar1268/creditsign/raw/0e1d51a9055b9b0c7c064f97295a7bccd0a16ca3/%ED%81%AC%EB%A0%88%EB%94%A7%EC%82%AC%EC%9D%B8%20%EA%B8%B0%EB%B3%B8%EC%84%B8%ED%8C%85%201.pdf",
    "양식 2": "https://cors-anywhere.herokuapp.com/https://github.com/moonstar1268/creditsign/raw/92b2d1f8901301b66d242b6efe5f0cae20cd75db/%ED%81%AC%EB%A0%88%EB%94%A7%EC%82%AC%EC%9D%B8%20%EA%B8%B0%EB%B3%B8%EC%84%B8%ED%8C%85%202.pdf"
  };

  let pdfDoc = null, pdfBytes = null, textMode = false;
  const textEntries = [];

  async function loadDefaultPDF(name){
    const pdfResponse = await fetch(pdfUrls[name]);
    pdfBytes = await pdfResponse.arrayBuffer();
    pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
    await renderPreview();
    document.getElementById("open-pad").disabled = false;
    document.getElementById("download").disabled = false;
  }

  async function renderPreview(){
    const wrap=document.getElementById("pdf-preview");
    wrap.innerHTML='';
    const pdf=await pdfjsLib.getDocument({data:pdfBytes}).promise;

    for(let i=1;i<=pdf.numPages;i++){
      const page=await pdf.getPage(i);
      const viewport=page.getViewport({scale:1.0});
      const canvas=document.createElement("canvas");
      canvas.width=viewport.width; canvas.height=viewport.height;
      await page.render({canvasContext:canvas.getContext("2d"),viewport}).promise;
      canvas.dataset.pageIndex=i-1;
      canvas.onclick=(e)=>canvasClickHandler(e, canvas);
      wrap.appendChild(canvas);
    }
  }

  function canvasClickHandler(e, canvas){
    if(textMode){
      const rect=canvas.getBoundingClientRect();
      const scaleX=canvas.width/rect.width;
      const scaleY=canvas.height/rect.height;
      const x=(e.clientX-rect.left)*scaleX;
      const y=(e.clientY-rect.top)*scaleY;
      const input=document.getElementById("text-input");
      input.style.left=e.clientX+'px';
      input.style.top=e.clientY+'px';
      input.value='';
      input.classList.remove('hidden');
      input.focus();

      input.onkeydown=(ev)=>{
        if(ev.key==="Enter"){
          const ctx=canvas.getContext("2d");
          ctx.font="16px Arial";
          ctx.fillText(input.value,x,y);
          textEntries.push({
            text:input.value,
            x:x, y:y, page:parseInt(canvas.dataset.pageIndex)
          });
          input.classList.add('hidden');
          textMode=false;
        }
      };

      input.onmousedown=(event)=>{
        let shiftX=event.clientX-input.getBoundingClientRect().left;
        let shiftY=event.clientY-input.getBoundingClientRect().top;

        function moveAt(pageX, pageY){
          input.style.left=pageX-shiftX+'px';
          input.style.top=pageY-shiftY+'px';
        }

        function onMouseMove(event){
          moveAt(event.pageX,event.pageY);
        }

        document.addEventListener('mousemove',onMouseMove);

        input.onmouseup=()=>{
          document.removeEventListener('mousemove',onMouseMove);
          input.onmouseup=null;
        };
      };

      input.ondragstart=()=>false;
    }
  }

  window.onload=()=>{
    pdfjsLib.GlobalWorkerOptions.workerSrc=
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    loadDefaultPDF("양식 1");
  };

  document.getElementById("form1-tab").onclick=()=>loadDefaultPDF("양식 1");
  document.getElementById("form2-tab").onclick=()=>loadDefaultPDF("양식 2");

  document.getElementById("text-add").onclick=()=>{
    textMode=true;
    alert("PDF에서 텍스트를 추가할 위치를 클릭해주세요.");
  };

  document.getElementById("download").onclick=async()=>{
    const pdf=await PDFLib.PDFDocument.load(pdfBytes);

    textEntries.forEach(t=>{
      const page=pdf.getPages()[t.page];
      page.drawText(t.text,{
        x:t.x, y:page.getHeight()-t.y-16, size:12
      });
    });

    const finalPdfBytes=await pdf.save();
    const blob=new Blob([finalPdfBytes],{type:"application/pdf"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;a.download="signed.pdf";a.click();
    URL.revokeObjectURL(url);
  };
</script>

<script src="script.js"></script>
</body>
</html>
