<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CreditSign</title>
  <link rel="stylesheet" href="styles.css">

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    #pdf-preview canvas { border:1px solid #ccc; margin-bottom:10px; }
    .hidden { display:none; }
    #name-img, #signature-img {
      position:absolute; cursor:move; border:1px solid #333;
    }
  </style>
</head>

<body>
  <h1>CreditSign</h1>

  <button id="form1-tab">양식 1</button>
  <button id="form2-tab">양식 2</button>
  <br><br>

  <button id="name-add">이름 입력</button>
  <button id="open-pad">➕ 서명 추가</button>
  <button id="download">⬇️ 서명된 문서 다운로드</button>

  <div id="pdf-preview"></div>

  <div id="pad-wrapper" class="hidden">
    <canvas id="sig-canvas" width="400" height="200"></canvas><br />
    <button id="clear">Clear</button>
    <button id="save-sig">Save</button>
  </div>

  <footer style="margin-top:20px;font-size:14px;color:#666;">
    Copyright (C) 한국금융범죄예방연구센터. All rights reserved.
  </footer>

<script>
const pdfUrls = {
  "양식 1": "크레딧사인 기본세팅 1.pdf",
  "양식 2": "크레딧사인 기본세팅 2.pdf"
};

let pdfBytes = null;
let padType = "";      // "name" or "sig"
let nameMode = false, sigMode = false;
let nameInfo = {}, sigInfo = {};

async function loadDefaultPDF(name) {
  const res = await fetch(pdfUrls[name]);
  pdfBytes = await res.arrayBuffer();
  nameMode = sigMode = false;
  nameInfo = {}; sigInfo = {};
  clearElements();
  await renderPreview();
}

function clearElements() {
  document.querySelectorAll('#name-img, #signature-img').forEach(el => el.remove());
  document.getElementById("pad-wrapper").classList.add("hidden");
}

async function renderPreview() {
  const wrap = document.getElementById("pdf-preview");
  wrap.innerHTML = '';
  const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: 1.0 });
    const canvas = document.createElement("canvas");
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    canvas.dataset.page = i - 1;
    canvas.onclick = e => canvasClickHandler(e, canvas);
    await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;
    wrap.appendChild(canvas);
  }
}

function canvasClickHandler(e, canvas) {
  if (nameMode) {
    const img = document.createElement("img");
    img.id = "name-img";
    img.src = nameInfo.dataURL;
    img.style.left = e.pageX + "px";
    img.style.top  = e.pageY + "px";
    img.style.width = "150px";
    document.body.appendChild(img);
    nameInfo.x = parseInt(img.style.left);
    nameInfo.y = parseInt(img.style.top);
    nameInfo.page = parseInt(canvas.dataset.page);
    dragElement(img);
    nameMode = false;
  } else if (sigMode) {
    const img = document.createElement("img");
    img.id = "signature-img";
    img.src = sigInfo.dataURL;
    img.style.left = e.pageX + "px";
    img.style.top  = e.pageY + "px";
    img.style.width = "150px";
    document.body.appendChild(img);
    sigInfo.x = parseInt(img.style.left);
    sigInfo.y = parseInt(img.style.top);
    sigInfo.page = parseInt(canvas.dataset.page);
    dragElement(img);
    sigMode = false;
  }
}

document.getElementById("name-add").onclick = () => {
  padType = "name"; nameMode = sigMode = false;
  document.getElementById("pad-wrapper").classList.remove("hidden");
  initSignaturePad();
};

document.getElementById("open-pad").onclick = () => {
  padType = "sig"; nameMode = sigMode = false;
  document.getElementById("pad-wrapper").classList.remove("hidden");
  initSignaturePad();
};

function initSignaturePad() {
  const canvas = document.getElementById("sig-canvas");
  if (window.signaturePad) {
    signaturePad.clear();
    return;
  }
  window.signaturePad = new SignaturePad(canvas);
  document.getElementById("clear").onclick = () => signaturePad.clear();
  document.getElementById("save-sig").onclick = () => {
    if (signaturePad.isEmpty()) {
      alert(padType === "name" ? "이름을 입력하세요" : "서명을 입력하세요");
      return;
    }
    const dataURL = signaturePad.toDataURL();
    if (padType === "name") {
      nameInfo.dataURL = dataURL;
      nameMode = true;
      alert("이름 위치를 클릭하세요");
    } else {
      sigInfo.dataURL = dataURL;
      sigMode = true;
      alert("서명 위치를 클릭하세요");
    }
    document.getElementById("pad-wrapper").classList.add("hidden");
  };
}

function dragElement(el) {
  el.onmousedown = e => {
    let shiftX = e.clientX - el.getBoundingClientRect().left;
    let shiftY = e.clientY - el.getBoundingClientRect().top;
    document.onmousemove = e => {
      el.style.left = e.pageX - shiftX + 'px';
      el.style.top  = e.pageY - shiftY + 'px';
    };
    document.onmouseup = () => {
      document.onmousemove = document.onmouseup = null;
    };
  };
}

document.getElementById("download").onclick = async () => {
  const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
  const pages = pdfDoc.getPages();
  const canvases = document.querySelectorAll('#pdf-preview canvas');

  // embed and draw name image
  if (nameInfo.dataURL) {
    const pngName = await pdfDoc.embedPng(nameInfo.dataURL);
    const page = pages[nameInfo.page];
    const rect = canvases[nameInfo.page].getBoundingClientRect();
    const scaleX = page.getWidth() / rect.width;
    const scaleY = page.getHeight() / rect.height;
    const x = (nameInfo.x - rect.left + window.scrollX) * scaleX;
    const y = page.getHeight() - ((nameInfo.y - rect.top + window.scrollY) * scaleY) - (50 * scaleY);
    page.drawImage(pngName, { x, y, width: 150 * scaleX, height: 50 * scaleY });
  }

  // embed and draw signature image
  if (sigInfo.dataURL) {
    const pngSig = await pdfDoc.embedPng(sigInfo.dataURL);
    const page = pages[sigInfo.page];
    const rect = canvases[sigInfo.page].getBoundingClientRect();
    const scaleX = page.getWidth() / rect.width;
    const scaleY = page.getHeight() / rect.height;
    const x = (sigInfo.x - rect.left + window.scrollX) * scaleX;
    const y = page.getHeight() - ((sigInfo.y - rect.top + window.scrollY) * scaleY) - (50 * scaleY);
    page.drawImage(pngSig, { x, y, width: 150 * scaleX, height: 50 * scaleY });
  }

  // save and download
  const pdfBytesOut = await pdfDoc.save();
  const blob = new Blob([pdfBytesOut], { type: "application/pdf" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "signed.pdf";
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    URL.revokeObjectURL(url);
    a.remove();
  }, 3000);
};

window.onload = () => {
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  loadDefaultPDF("양식 1");
};
document.getElementById("form1-tab").onclick = () => loadDefaultPDF("양식 1");
document.getElementById("form2-tab").onclick = () => loadDefaultPDF("양식 2");
</script>
</body>
</html>
