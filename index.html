<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CreditSign</title>
  <link rel="stylesheet" href="styles.css">

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    #pdf-preview canvas {border:1px solid #ccc; margin-bottom:10px;}
    .hidden {display:none;}
    .fixed-text {
      position:absolute;font-size:16px;padding:4px;border:1px solid #000;background:#fff;
    }
    #signature-img {
      position:absolute;cursor:move;border:1px solid #333;
    }
  </style>
</head>

<body>
  <h1>CreditSign</h1>

  <button id="form1-tab">ì–‘ì‹ 1</button>
  <button id="form2-tab">ì–‘ì‹ 2</button>
  <br><br>

  <button id="enter-name">ğŸ“ ì´ë¦„ ì…ë ¥</button>
  <button id="open-pad">â• ì„œëª… ì¶”ê°€</button>
  <button id="download">â¬‡ï¸ ì„œëª…ëœ ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ</button>

  <div id="pdf-preview" style="position:relative;"></div>

  <div id="pad-wrapper" class="hidden">
    <canvas id="sig-canvas" width="400" height="200"></canvas><br>
    <button id="clear">Clear</button>
    <button id="save-sig">Save Signature</button>
  </div>

  <footer style="margin-top:20px;font-size:14px;color:#666;">
    Copyright (C) í•œêµ­ê¸ˆìœµë²”ì£„ì˜ˆë°©ì—°êµ¬ì„¼í„°. All rights reserved.
  </footer>

<script>
const pdfUrls={
  "ì–‘ì‹ 1":"í¬ë ˆë”§ì‚¬ì¸ ê¸°ë³¸ì„¸íŒ… 1.pdf",
  "ì–‘ì‹ 2":"í¬ë ˆë”§ì‚¬ì¸ ê¸°ë³¸ì„¸íŒ… 2.pdf"
};

const textPositions={
  "ì–‘ì‹ 1":{x:180,y:830}, // ì–‘ì‹1ì˜ ì´ë¦„ ì…ë ¥ ìœ„ì¹˜
  "ì–‘ì‹ 2":{x:180,y:770}  // ì–‘ì‹2ì˜ ì´ë¦„ ì…ë ¥ ìœ„ì¹˜
};

let pdfBytes=null, currentForm="ì–‘ì‹ 1";
let enteredName='', sigInfo=null;

async function loadDefaultPDF(name){
  currentForm=name; enteredName=''; sigInfo=null;
  clearPreviousElements();
  const res=await fetch(pdfUrls[name]);
  pdfBytes=await res.arrayBuffer();
  await renderPreview();
}

function clearPreviousElements(){
  document.querySelectorAll('.fixed-text,#signature-img').forEach(el=>el.remove());
  document.getElementById("pad-wrapper").classList.add("hidden");
}

async function renderPreview(){
  const wrap=document.getElementById("pdf-preview");wrap.innerHTML='';
  wrap.style.position='relative';
  const pdf=await pdfjsLib.getDocument({data:pdfBytes}).promise;
  const page=await pdf.getPage(1);
  const viewport=page.getViewport({scale:1});
  const canvas=document.createElement("canvas");
  canvas.width=viewport.width; canvas.height=viewport.height;
  await page.render({canvasContext:canvas.getContext("2d"),viewport}).promise;
  wrap.appendChild(canvas);

  const pos=textPositions[currentForm];
  const textDiv=document.createElement("div");
  textDiv.className="fixed-text";
  textDiv.style.left=pos.x+"px";textDiv.style.top=pos.y+"px";
  textDiv.innerText="(ì´ë¦„ í´ë¦­í•˜ì—¬ ì…ë ¥)";
  textDiv.onclick=()=>inputName(textDiv);
  wrap.appendChild(textDiv);
}

function inputName(el){
  const name=prompt("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
  if(name){
    el.innerText=name;enteredName=name;
  }
}

document.getElementById("enter-name").onclick=()=>{
  document.querySelector('.fixed-text').click();
};

document.getElementById("open-pad").onclick=()=>{
  document.getElementById("pad-wrapper").classList.remove("hidden");
  initSignaturePad();
};

function initSignaturePad(){
  const canvas=document.getElementById("sig-canvas");
  if(window.signaturePad){signaturePad.clear();return;}
  window.signaturePad=new SignaturePad(canvas);
  document.getElementById("clear").onclick=()=>signaturePad.clear();
  document.getElementById("save-sig").onclick=()=>{
    if(signaturePad.isEmpty()){alert("ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");return;}
    sigInfo={dataURL:signaturePad.toDataURL()};
    document.getElementById("pad-wrapper").classList.add("hidden");
    alert("PDFì—ì„œ ì„œëª…ì„ ì¶”ê°€í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.");
    document.getElementById("pdf-preview").onclick=function(e){
      const rect=this.getBoundingClientRect();
      sigInfo.x=e.clientX-rect.left;
      sigInfo.y=e.clientY-rect.top;
      addSignatureImg(sigInfo.dataURL,sigInfo.x,sigInfo.y);
      this.onclick=null;
    };
  };
}

function addSignatureImg(src,x,y){
  const img=document.createElement("img");
  img.id="signature-img";img.src=src;
  img.style.left=x+"px";img.style.top=y+"px";img.style.width="150px";
  document.getElementById("pdf-preview").appendChild(img);
  dragElement(img);
}

function dragElement(el){
  el.onmousedown=(e)=>{
    let shiftX=e.clientX-el.getBoundingClientRect().left;
    let shiftY=e.clientY-el.getBoundingClientRect().top;
    document.onmousemove=(e)=>{el.style.left=e.pageX-shiftX+'px';el.style.top=e.pageY-shiftY+'px';};
    document.onmouseup=()=>{document.onmousemove=null;document.onmouseup=null;};
  };
}

document.getElementById("download").onclick=async()=>{
  const pdf=await PDFLib.PDFDocument.load(pdfBytes);
  const page=pdf.getPages()[0];

  if(enteredName){
    page.drawText(enteredName,{
      x:textPositions[currentForm].x,
      y:page.getHeight()-textPositions[currentForm].y-15,
      size:14
    });
  }

  if(sigInfo){
    const png=await pdf.embedPng(sigInfo.dataURL);
    page.drawImage(png,{
      x:sigInfo.x,
      y:page.getHeight()-sigInfo.y-50,
      width:150,height:50
    });
  }

  const finalPdfBytes=await pdf.save();
  const blob=new Blob([finalPdfBytes],{type:"application/pdf"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="signed.pdf";a.click();
  URL.revokeObjectURL(a.href);
};

window.onload=()=>{
  pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  loadDefaultPDF("ì–‘ì‹ 1");
};

document.getElementById("form1-tab").onclick=()=>loadDefaultPDF("ì–‘ì‹ 1");
document.getElementById("form2-tab").onclick=()=>loadDefaultPDF("ì–‘ì‹ 2");
</script>
</body>
</html>
